#!/bin/bash

main() {
  local main_cmd="nex $1 $2 $3"
  local fn_1=fn_$1
  local script_1=$1'_'$2'_'$3.sh
  local script_2=$1'_'$2.sh
  local script_3=$1.sh
  local cmd_1=_nx_$1'_'$2
  local cmd_2=_nx_$1
  if [ "$(type -t $fn_1)" == function ]; then
    $fn_1 ${@:2}
    return 0
  fi

  if [ -z "$1" ]; then
    fn_hello
    return 1
  fi

  try_scripts
  try_commands
  
  echo " not_found: $main_cmd"
}

is_cmd() {
  if command -v $1 &> /dev/null; then
    return 0
  else
    return 1
  fi
}

try_commands() {
  if is_cmd $cmd_1; then
    run_cmd $cmd_1 "${@:3}"
  elif is_cmd $cmd_2; then
    run_cmd $cmd_2 "${@:2}"
  fi
}

try_scripts() {
  script_base=$(get_cli_path)/src/script
  if is_file "$script_base/$script_1"; then
    run_script $script_1 "${@:4}"
  elif is_file "$script_2"; then
    run_script $script_2 "${@:3}"
  elif is_file "$script_2"; then
    run_script $script_3 "${@:2}"
  fi
}

is_file() {
  if [[ -f "$1" ]]; then
    return 0
  else
    return 1
  fi
}

run_script() {
  bash $(get_cli_path)/src/script/$1 ${@:2}
  exit
}

run_cmd() {
  "$1" ${@:2}
  exit
}

fn_hello() {
  echo " Hello Nex CLI !"
  echo " Usage: nex <1> <2> <3>"
  echo
}

fn_init() {
  export nex_support=$(get_cli_path)/support
  bash $nex_support/install/run_default.sh "cli.nex"
}

fn__config() {
  get_config_path
}

fn__root() {
  get_root_path $1
}

fn__plugin() {
  get_plugin_path $1
}

fn__mod() {
  get_mod_path $1
}

get_home() {
  echo "$(get_nex_root)/.."
}

get_nex_root() {
  echo $HOME/dotfiles 
}

get_cli_path() {
  echo $(get_nex_root)/cli.nex
}

get_config_path() {
  echo $(get_cli_path)/dist/config.sh
}

get_root_path() {
  if [ -z "$1" ]; then
    echo $(get_nex_root)
  else
    echo $(get_nex_root)/$1.nex
  fi
}

get_plugin_path() {
  echo $(get_nex_root)/plugins/$1.plugin
}

get_mod_path() {
  if [[ $1 == "u" ]] || [[ $1 == "user" ]]; then
    echo $(get_home)/user_mod
  else
    echo $(get_nex_root)/mods/$1.mod
  fi 
}

main "$@"
